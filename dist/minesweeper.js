"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),Minesweeper=function(){function e(t){_classCallCheck(this,e),this.GAME_CONTAINER=null,this.GAME_STATE={},this.difficultySettings={0:{TILES_X:9,TILES_Y:9,BOMB_RATIO:.15625},1:{TILES_X:15,TILES_Y:15,BOMB_RATIO:.15625},2:{TILES_X:30,TILES_Y:15,BOMB_RATIO:.20625}},this.defaults=this.difficultySettings[1],this.neighbourOffsets=[{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-1,y:0},{x:1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1}],this.setupGameContainer(t),this.startGame(this.defaults)}return _createClass(e,[{key:"startGame",value:function(e){this.setInitialGamestate(e),this.GAME_CONTAINER.className="minesweeper__board cols-"+e.TILES_X+" rows-"+e.TILES_Y,this.generateTiles(),this.drawTiles(),this.bindTileClick()}},{key:"setInitialGamestate",value:function(e){this.GAME_STATE.TILES_X=e.TILES_X,this.GAME_STATE.TILES_Y=e.TILES_Y,this.GAME_STATE.TILES=[],this.GAME_STATE.CLEARED_TILES=[],this.GAME_STATE.BOMB_RATIO=e.BOMB_RATIO,this.GAME_STATE.BOMBS=[],this.GAME_STATE.FLAGGED=[],this.GAME_STATE.GAME_STARTED=!1,this.GAME_STATE.GAME_WON=!1,this.GAME_STATE.GAME_OVER=!1}},{key:"setupGameContainer",value:function(e){var t=document.getElementById(e),i=document.createElement("div"),s=document.createElement("div");s.className="minesweeper__controls",s.innerHTML='<ul>                <li><button class="minesweeper__dificulty-selector" data-difficulty="0">Beginner</button></li>                <li><button class="minesweeper__dificulty-selector" data-difficulty="1">Intermediate</button></li>                <li><button class="minesweeper__dificulty-selector" data-difficulty="2">Expert</button></li>            </ul>',t.appendChild(i),t.appendChild(s),this.bindControls(),this.GAME_CONTAINER=i}},{key:"bindControls",value:function(){function e(e){var t=e.dataset.difficulty;this.startGame(this.difficultySettings[t])}for(var t=document.getElementsByClassName("minesweeper__dificulty-selector"),i=0;i<t.length;i++)t[i].addEventListener("click",e.bind(this,t[i]))}},{key:"generateTiles",value:function(){for(var e=this.GAME_STATE.TILES_X*this.GAME_STATE.TILES_Y,t=0;e>t;t++){var i=this.getTileCoords(t);this.elem=null,i.isCleared=!1,i.isBomb=!1,i.flagged=!1,this.neighbouringBombs=0,this.GAME_STATE.TILES.push(i)}}},{key:"drawTiles",value:function(){for(var e="",t=0;t<this.GAME_STATE.TILES.length;t++)e+="<div class='minesweeper__tile'></div>";this.GAME_CONTAINER.innerHTML=e}},{key:"generateGame",value:function(t,i){var s=this,n=Math.ceil(this.GAME_STATE.TILES_X*this.GAME_STATE.TILES_Y*this.GAME_STATE.BOMB_RATIO),E=[],T=[];T=this.getNeighbourTiles(t,i).map(function(e){return e.tileIndex}),T.push(this.getTileIndex(t,i));for(var l=0,a=this.GAME_STATE.TILES.length;a>l;l++)T.indexOf(l)>-1||E.push(l);E=e.shuffle(E),this.GAME_STATE.BOMBS=E.splice(0,n),this.GAME_STATE.BOMBS.sort(function(e,t){return t>e?-1:e>t?1:0}),this.GAME_STATE.BOMBS.map(function(e){s.updateTileState(e,{isBomb:!0})}),this.GAME_STATE.GAME_STARTED=!0}},{key:"bindTileClick",value:function(){function e(e,t){if(this.GAME_STATE.GAME_OVER||this.GAME_STATE.GAME_OVER.GAME_WON)return void this.startGame(this.GAME_STATE);if(!e.isCleared&&!e.isFlagged){if(this.GAME_STATE.GAME_STARTED){if(e.isBomb)return void this.gameOver(e)}else this.generateGame(e.x,e.y);var i=this.sweep(t);this.renderTiles(i),this.allTilesCleared()&&this.gameWon()}}function t(e,t){if(this.GAME_STATE.GAME_OVER||this.GAME_STATE.GAME_OVER.GAME_WON)return void this.startGame(this.GAME_STATE);if(e.isFlagged=!e.isFlagged,this.renderTiles([t]),e.isFlagged)this.GAME_STATE.FLAGGED.push(t);else{var i=this.GAME_STATE.FLAGGED.indexOf(t);this.GAME_STATE.FLAGGED.splice(i,1)}this.allBombsFlagged()&&this.gameWon()}for(var i=this,s=this.GAME_CONTAINER.getElementsByClassName("minesweeper__tile"),n=function(n){var E=i.GAME_STATE.TILES[n];E.elem=s[n],E.elem.addEventListener("click",e.bind(i,E,n)),E.elem.addEventListener("contextmenu",function(e){e.preventDefault(),t.call(i,E,n)},!1)},E=0;E<this.GAME_STATE.TILES.length;E++)n(E)}},{key:"allBombsFlagged",value:function(){if(this.GAME_STATE.FLAGGED.length!==this.GAME_STATE.BOMBS.length)return!1;this.GAME_STATE.FLAGGED.sort(function(e,t){return t>e?-1:e>t?1:0});for(var e=0;e<this.GAME_STATE.FLAGGED.length;e++)if(this.GAME_STATE.FLAGGED[e]!==this.GAME_STATE.BOMBS[e])return!1;return!0}},{key:"allTilesCleared",value:function(){return this.GAME_STATE.CLEARED_TILES.length===this.GAME_STATE.TILES.length-this.GAME_STATE.BOMBS.length}},{key:"gameOver",value:function(e){this.GAME_STATE.GAME_OVER=!0,this.GAME_CONTAINER.className+=" game-over",e.elem.className+=" bomb--exploded",this.renderTiles(this.GAME_STATE.BOMBS,!0)}},{key:"gameWon",value:function(){console.log("Game won!")}},{key:"getTileCoords",value:function(e){var t=e%this.GAME_STATE.TILES_X,i=Math.floor(e/this.GAME_STATE.TILES_X);return{x:t,y:i}}},{key:"getTileIndex",value:function(e,t){return t*this.GAME_STATE.TILES_X+e}},{key:"updateTileState",value:function(e,t){for(var i in t)this.GAME_STATE.TILES[e][i]=t[i]}},{key:"getNeighbourTiles",value:function(e,t){for(var i=[],s=0;s<this.neighbourOffsets.length;s++){var n=e+this.neighbourOffsets[s].x,E=t+this.neighbourOffsets[s].y;0>n||n>this.GAME_STATE.TILES_X-1||0>E||E>this.GAME_STATE.TILES_Y-1||i.push({x:n,y:E,tileIndex:this.getTileIndex(n,E)})}return i}},{key:"renderTiles",value:function(e,t){var i=this;e.map(function(e){var s=i.GAME_STATE.TILES[e],n="";if(t&&s.isBomb)n=" is-bomb";else if(s.isCleared){if(n=" is-cleared",s.neighbouringBombs>0){var E=s.neighbouringBombs;n+=" bombs--"+(E>4?4:E)}}else s.isFlagged?n=" is-flagged":s.elem.className=s.elem.className.replace(/\sis-flagged/g,"");s.elem.className+=n,s.neighbouringBombs&&!t&&(s.elem.innerHTML=s.neighbouringBombs)})}},{key:"sweep",value:function(e){function t(e,t){var i=String(e)+String(t);if(!(l.indexOf(i)>-1)){l.push(i);for(var s=0,n=this.getNeighbourTiles(e,t),a=0;a<n.length;a++){var r=n[a].tileIndex;this.GAME_STATE.TILES[r].isBomb&&s++}var r=this.getTileIndex(e,t);this.GAME_STATE.TILES[r].isFlagged||(this.updateTileState(r,{neighbouringBombs:s,isCleared:!0}),-1===this.GAME_STATE.CLEARED_TILES.indexOf(r)&&this.GAME_STATE.CLEARED_TILES.push(r)),T.push(r),0===s&&(E=E.concat(n))}}for(var i=this.getTileCoords(e),s=i.x,n=i.y,E=[{x:s,y:n}],T=[],l=[],a=0;a<E.length;a++)t.call(this,E[a].x,E[a].y);return T}}],[{key:"shuffle",value:function(e){for(var t,i,s=e.length;s>0;)i=Math.floor(Math.random()*s--),t=e[s],e[s]=e[i],e[i]=t;return e}}]),e}();
